<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SD 分镜 Prompt 管理器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --sticky-offset: 80px;
      }
      html {
        scroll-behavior: smooth;
      }

      .topbar-sticky {
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: blur(6px);
      }

      aside.toc-sticky {
        position: sticky;
        top: calc(var(--sticky-offset) + 8px);
        height: calc(100vh - var(--sticky-offset) - 16px);
        overflow: auto;
      }

      article.card {
        scroll-margin-top: calc(var(--sticky-offset) + 8px);
        position: relative;
      }

      .toc-item[draggable="true"] {
        cursor: grab;
      }
      .toc-item.dragging {
        opacity: 0.75;
      }
      .toc-item.drop-target {
        outline: 2px dashed rgba(16, 185, 129, 0.6);
        outline-offset: 2px;
        border-radius: 8px;
      }
      .toc-item.active {
        background: rgba(59, 130, 246, 0.18);
      }

      .rp-toggle-arrow {
        display: inline-block;
        transition: transform 0.18s ease;
      }
      .rp-enabled .rp-toggle-arrow {
        transform: rotate(90deg);
      }

      /* RP 面板宽度 160px（减半） */
      .rp-panel {
        position: absolute;
        top: 0;
        left: calc(100% + 12px);
        width: 160px;
        max-width: 80vw;
        border: 1px solid rgb(38 38 38);
        background: rgba(10, 10, 10, 0.95);
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 4px 22px rgba(0, 0, 0, 0.45);
        display: none;
        z-index: 10;
      }
      .rp-panel.show {
        display: block;
      }
      .rp-field {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
      }
      .rp-input {
        width: 88px;
        padding: 4px 6px;
        border: 1px solid rgb(38 38 38);
        background: rgb(10 10 10);
        border-radius: 8px;
        font-size: 12px;
        color: #e5e5e5;
        outline: none;
      }
      .rp-input:focus {
        border-color: rgb(82 82 82);
      }

      .index-badge {
        position: absolute;
        top: 8px;
        left: 12px;
        font-size: 1rem;
        font-weight: 700;
        color: #a3a3a3;
        pointer-events: none;
      }

      .scroll-spy-anchor {
        position: absolute;
        top: 0;
        height: 1px;
        width: 1px;
      }
    </style>
  </head>
  <body class="min-h-screen bg-neutral-950 text-neutral-100">
    <div class="mx-auto max-w-6xl px-4 lg:px-6 py-0">
      <div class="topbar-sticky bg-neutral-950/80">
        <div class="py-4 lg:py-5">
          <header
            class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between"
          >
            <h1 class="text-2xl font-semibold tracking-tight">
              SD 分镜 Prompt 管理器
            </h1>

            <!-- 顶部右侧：新增全局大标题 + 按钮组 -->
            <div
              class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3"
            >
              <a
                href="viewer/"
                class="rounded-2xl border border-neutral-700 px-4 py-2 text-sm hover:bg-neutral-800 active:scale-[0.99]"
              >
                阅览器
              </a>

              <input
                id="sceneTitleInput"
                type="text"
                class="min-w-[220px] sm:w-[260px] rounded-2xl border border-neutral-700 bg-neutral-950 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-neutral-700"
                placeholder="小剧场大标题（可选）"
              />

              <div class="flex flex-wrap gap-2">
                <button
                  id="btnReset"
                  class="rounded-2xl border border-red-500/60 text-red-300 px-4 py-2 text-sm hover:bg-red-950/40 active:scale-[0.99]"
                >
                  重新开始
                </button>
                <button
                  id="btnImport"
                  class="rounded-2xl border border-neutral-700 px-4 py-2 text-sm hover:bg-neutral-800 active:scale-[0.99]"
                >
                  导入 TXT
                </button>
                <input
                  id="fileInput"
                  type="file"
                  accept=".txt,application/json,text/plain"
                  class="hidden"
                />
                <button
                  id="btnExport"
                  class="rounded-2xl border border-neutral-700 px-4 py-2 text-sm hover:bg-neutral-800 active:scale-[0.99]"
                >
                  导出 TXT
                </button>
                <button
                  id="btnAdd"
                  class="rounded-2xl bg-neutral-100 px-4 py-2 text-sm font-medium text-neutral-900 hover:bg-white active:scale-[0.99]"
                >
                  + 新建分镜
                </button>
              </div>
            </div>
          </header>
          <p
            id="status"
            class="mt-3 text-sm text-emerald-400 hidden"
            role="status"
          ></p>
        </div>
      </div>

      <div class="mt-3 text-xs text-neutral-500">
        提示：左侧目录支持拖拽排序与自动高亮；点击目录会将分镜卡片对齐到顶部
        sticky 标题下方并留空隙。右侧“Regional
        Prompter”面板默认折叠，启用后向右展开。
      </div>

      <div class="mt-4 grid grid-cols-1 gap-6 lg:grid-cols-[260px,1fr]">
        <aside
          class="toc-sticky rounded-2xl border border-neutral-800 bg-neutral-900/40 p-4"
        >
          <div class="mb-2 text-sm text-neutral-300">分镜目录（拖拽排序）</div>
          <nav id="toc" class="space-y-1 text-sm"></nav>
        </aside>

        <main>
          <section id="list" class="space-y-6"></section>

          <footer
            class="mt-10 border-t border-neutral-800 pt-4 text-xs leading-6 text-neutral-400"
          >
            <p>导出格式说明（v3）：生成的 <code>.txt</code> 文件为 JSON：</p>
            <pre
              class="mt-2 overflow-x-auto rounded-xl border border-neutral-800 bg-neutral-950 p-3"
            ><code>{
  "type": "sd-shot-list",
  "version": 3,
  "exportedAt": "ISO8601",
  "sceneTitle": "（可选）你的大标题",
  "items": [
    {
      "title": "分镜 1",
      "summary": "",
      "positive": "...",
      "negative": "...",
      "rpEnabled": false,
      "rpOrientation": "vertical",
      "rpDivideRatio": "",
      "rpOverlayRatio": ""
    }
  ]
}</code></pre>
            <p class="mt-2">导入兼容 v1/v2（自动填充 v3 新字段，默认垂直）。</p>
          </footer>
        </main>
      </div>

      <button
        id="btnTop"
        title="回到顶部"
        class="fixed bottom-5 right-5 rounded-full border border-neutral-700 bg-neutral-900/80 px-3 py-2 text-sm hover:bg-neutral-800"
      >
        ↑ 回到顶部
      </button>
    </div>

    <script>
      /** @typedef {{
       *  id:string, title:string, summary:string, positive:string, negative:string,
       *  rpEnabled:boolean, rpOrientation:'horizontal'|'vertical',
       *  rpDivideRatio:string, rpOverlayRatio:string
       * }} Shot */

      const uid = () =>
        Math.random().toString(36).slice(2) + Date.now().toString(36);

      const LS_KEY_V3 = "sd-shot-list-v3";
      const LS_KEY_V2 = "sd-shot-list-v2";
      const LS_KEY_V1 = "sd-shot-list-v1";
      const SIG = { type: "sd-shot-list", version: 3 };

      /** 全局标题（小剧场大标题） */
      let sceneTitle = "";

      /** @type {Shot[]} */
      let shots = [
        {
          id: uid(),
          title: "分镜 1",
          summary: "",
          positive: "",
          negative: "",
          rpEnabled: false,
          rpOrientation: "vertical", // 默认：垂直
          rpDivideRatio: "",
          rpOverlayRatio: "",
        },
      ];

      // refs
      const listEl = document.getElementById("list");
      const tocEl = document.getElementById("toc");
      const statusEl = document.getElementById("status");
      const fileInputEl = document.getElementById("fileInput");
      const btnImport = document.getElementById("btnImport");
      const btnExport = document.getElementById("btnExport");
      const btnAdd = document.getElementById("btnAdd");
      const btnReset = document.getElementById("btnReset");
      const btnTop = document.getElementById("btnTop");
      const sceneTitleInput = document.getElementById("sceneTitleInput");

      function computeStickyOffset() {
        const topbar = document.querySelector(".topbar-sticky");
        const extraGap = 12;
        const h = (topbar?.offsetHeight || 0) + extraGap;
        document.documentElement.style.setProperty("--sticky-offset", h + "px");
      }
      window.addEventListener("resize", computeStickyOffset);

      // ---- 兼容导入/加载 v3/v2/v1 ----
      (function initLoad() {
        try {
          const rawV3 = localStorage.getItem(LS_KEY_V3);
          if (rawV3) {
            const parsed = JSON.parse(rawV3);
            if (
              parsed?.type === SIG.type &&
              parsed?.version === 3 &&
              Array.isArray(parsed.items)
            ) {
              sceneTitle = String(parsed.sceneTitle ?? "");
              shots = parsed.items.map((it) => ({
                id: uid(),
                title: String(it.title ?? ""),
                summary: String(it.summary ?? ""),
                positive: String(it.positive ?? ""),
                negative: String(it.negative ?? ""),
                rpEnabled: Boolean(it.rpEnabled ?? false),
                rpOrientation:
                  it.rpOrientation === "horizontal" ||
                  it.rpOrientation === "vertical"
                    ? it.rpOrientation
                    : "vertical",
                rpDivideRatio: String(it.rpDivideRatio ?? ""),
                rpOverlayRatio: String(it.rpOverlayRatio ?? ""),
              }));
            } else {
              // 尝试 v2 / v1
              loadLegacy();
            }
          } else {
            loadLegacy();
          }
        } catch {
          /* ignore */
        }

        // 初始化全局标题输入框
        sceneTitleInput.value = sceneTitle;
        sceneTitleInput.addEventListener("input", (e) => {
          sceneTitle = e.target.value || "";
          persist();
        });
      })();

      function loadLegacy() {
        try {
          const rawV2 = localStorage.getItem(LS_KEY_V2);
          if (rawV2) {
            const parsed = JSON.parse(rawV2);
            if (
              parsed?.type === "sd-shot-list" &&
              parsed?.version === 2 &&
              Array.isArray(parsed.items)
            ) {
              shots = parsed.items.map((it) => ({
                id: uid(),
                title: String(it.title || ""),
                summary: "",
                positive: String(it.positive || ""),
                negative: "",
                rpEnabled: false,
                rpOrientation: "vertical",
                rpDivideRatio: "",
                rpOverlayRatio: "",
              }));
              return;
            }
          }
          const rawV1 = localStorage.getItem(LS_KEY_V1);
          if (rawV1) {
            const parsed = JSON.parse(rawV1);
            if (
              parsed?.type === "sd-shot-list" &&
              parsed?.version === 1 &&
              Array.isArray(parsed.items)
            ) {
              shots = parsed.items.map((it) => ({
                id: uid(),
                title: String(it.title || ""),
                summary: "",
                positive: String(it.prompt || ""),
                negative: "",
                rpEnabled: false,
                rpOrientation: "vertical",
                rpDivideRatio: "",
                rpOverlayRatio: "",
              }));
            }
          }
        } catch {
          /* ignore */
        }
      }

      function persist() {
        const payload = {
          ...SIG,
          sceneTitle,
          items: shots.map(
            ({
              title,
              summary,
              positive,
              negative,
              rpEnabled,
              rpOrientation,
              rpDivideRatio,
              rpOverlayRatio,
            }) => ({
              title,
              summary,
              positive,
              negative,
              rpEnabled,
              rpOrientation,
              rpDivideRatio,
              rpOverlayRatio,
            })
          ),
        };
        try {
          localStorage.setItem(LS_KEY_V3, JSON.stringify(payload));
        } catch {}
      }

      // ---- 渲染列表 ----
      function renderList() {
        listEl.innerHTML = "";
        shots.forEach((shot, index) => {
          const article = document.createElement("article");
          article.className =
            "card rounded-2xl border bg-neutral-900/40 p-4 pb-4 shadow-[0_0_0_1px_rgba(255,255,255,0.02)] transition-all border-neutral-800";
          article.dataset.index = String(index);
          article.id = `shot-${shot.id}`;

          const indexBadge = document.createElement("div");
          indexBadge.className = "index-badge";
          indexBadge.textContent = `#${index + 1}`;
          article.appendChild(indexBadge);

          // Header：RP 折叠/启用按钮
          const header = document.createElement("div");
          header.className = "flex items-center justify-end gap-2";
          header.innerHTML = `
            <button class="rp-toggle rounded-xl border border-neutral-700 px-2 py-1 text-xs hover:bg-neutral-800">
              <span class="rp-toggle-arrow">&gt;</span>
              <span class="ml-1 rp-status">${
                shot.rpEnabled ? "已启用分割" : "未启用分割"
              }</span>
            </button>
          `;
          if (shot.rpEnabled)
            header.querySelector(".rp-toggle").classList.add("rp-enabled");
          article.appendChild(header);

          // Title
          const inputTitle = document.createElement("input");
          inputTitle.className =
            "mt-2 w-full rounded-xl border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-neutral-700";
          inputTitle.setAttribute("data-role", "title");
          inputTitle.placeholder = `分镜 ${index + 1}`;
          inputTitle.value = shot.title;
          inputTitle.addEventListener("input", (e) => {
            shots[index].title = e.target.value;
            persist();
            renderTOC();
          });
          article.appendChild(inputTitle);

          // 简介
          const summaryInput = document.createElement("input");
          summaryInput.className =
            "mt-2 w-full rounded-xl border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-neutral-700";
          summaryInput.placeholder = "简介：用于对本分镜进行简要说明（可选）";
          summaryInput.value = shot.summary || "";
          summaryInput.addEventListener("input", (e) => {
            shots[index].summary = e.target.value;
            persist();
          });
          article.appendChild(summaryInput);

          // Positive
          const posRow = document.createElement("div");
          posRow.className = "mt-4 flex items-center justify-between gap-2";
          posRow.innerHTML = `
            <div class="text-sm text-neutral-300">Positive Prompt</div>
            <button class="btn-copy text-xs rounded-lg border border-neutral-700 px-2 py-1 hover:bg-neutral-800" data-target="pos-${shot.id}">复制</button>
          `;
          article.appendChild(posRow);

          const taPos = document.createElement("textarea");
          taPos.id = `pos-${shot.id}`;
          taPos.className =
            "mt-2 w-full resize-y rounded-xl border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm leading-6 outline-none focus:ring-2 focus:ring-neutral-700";
          taPos.rows = 5;
          taPos.placeholder =
            "正向提示词：masterpiece, ultra-detailed, cinematic lighting, ...";
          taPos.value = shot.positive;
          taPos.addEventListener("input", (e) => {
            shots[index].positive = e.target.value;
            persist();
          });
          article.appendChild(taPos);

          // Negative
          const negRow = document.createElement("div");
          negRow.className = "mt-4 flex items-center justify-between gap-2";
          negRow.innerHTML = `
            <div class="text-sm text-neutral-300">Negative Prompt</div>
            <button class="btn-copy text-xs rounded-lg border border-neutral-700 px-2 py-1 hover:bg-neutral-800" data-target="neg-${shot.id}">复制</button>
          `;
          article.appendChild(negRow);

          const taNeg = document.createElement("textarea");
          taNeg.id = `neg-${shot.id}`;
          taNeg.className =
            "mt-2 w-full resize-y rounded-xl border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm leading-6 outline-none focus:ring-2 focus:ring-neutral-700";
          taNeg.rows = 5;
          taNeg.placeholder = "负向提示词：lowres, bad anatomy, blurry, ...";
          taNeg.value = shot.negative;
          taNeg.addEventListener("input", (e) => {
            shots[index].negative = e.target.value;
            persist();
          });
          article.appendChild(taNeg);

          // 操作行（左：在下方添加分镜；右：删除）
          const actionRow = document.createElement("div");
          actionRow.className = "mt-4 flex items-center justify-between gap-3";

          const btnAddBelow = document.createElement("button");
          btnAddBelow.className =
            "rounded-xl bg-neutral-100 px-3 py-1.5 text-sm font-medium text-neutral-900 hover:bg-white active:scale-[0.99]";
          btnAddBelow.textContent = "+ 在下方添加分镜";
          btnAddBelow.addEventListener("click", () => addShotAfter(index));

          const btnDelete = document.createElement("button");
          btnDelete.className =
            "rounded-xl border px-3 py-1.5 text-xs font-medium border-red-500/50 text-red-300 bg-red-600/10 hover:bg-red-600/20";
          btnDelete.title = "删除该分镜";
          btnDelete.textContent = "删除";
          btnDelete.addEventListener("click", () => removeShot(index));

          actionRow.appendChild(btnAddBelow);
          actionRow.appendChild(btnDelete);
          article.appendChild(actionRow);

          // 右侧 Regional Prompter 浮出面板（默认空白，宽度 160）
          const rpPanel = document.createElement("div");
          rpPanel.className = "rp-panel" + (shot.rpEnabled ? " show" : "");
          rpPanel.innerHTML = `
            <div class="text-sm font-medium text-neutral-200">Regional Prompter</div>
            <div class="mt-2">
              <button class="rp-orient rounded-lg border border-neutral-700 px-2 py-1 text-xs hover:bg-neutral-800">
                <span class="orient-text">${
                  shot.rpOrientation === "vertical" ? "垂直" : "水平"
                }</span>
              </button>
            </div>
            <div class="rp-field">
              <label class="text-xs text-neutral-400">Divide Ratio</label>
              <input class="rp-input rp-divide" type="text" placeholder="1,1" value="${
                shot.rpDivideRatio || ""
              }">
            </div>
            <div class="rp-field">
              <label class="text-xs text-neutral-400">Overlay Ratio</label>
              <input class="rp-input rp-overlay" type="text" placeholder="0.5" value="${
                shot.rpOverlayRatio || ""
              }">
            </div>
          `;
          article.appendChild(rpPanel);

          // 复制
          article.querySelectorAll(".btn-copy").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              const targetId = e.currentTarget.getAttribute("data-target");
              const ta = document.getElementById(targetId);
              if (!ta) return;
              const text = ta.value;
              try {
                if (navigator.clipboard?.writeText) {
                  await navigator.clipboard.writeText(text);
                } else {
                  ta.select();
                  document.execCommand("copy");
                  ta.setSelectionRange(ta.value.length, ta.value.length);
                }
                toast(`已复制到剪贴板`);
              } catch {
                alert("复制失败");
              }
            });
          });

          // RP 折叠/启用
          const rpToggle = header.querySelector(".rp-toggle");
          const rpStatus = header.querySelector(".rp-status");
          rpToggle.addEventListener("click", () => {
            const now = !shots[index].rpEnabled;
            shots[index].rpEnabled = now;
            if (rpStatus)
              rpStatus.textContent = now ? "已启用分割" : "未启用分割";
            rpToggle.classList.toggle("rp-enabled", now);
            rpPanel.classList.toggle("show", now);
            persist();
          });

          // RP 面板设置
          rpPanel.querySelector(".rp-orient").addEventListener("click", () => {
            shots[index].rpOrientation =
              shots[index].rpOrientation === "horizontal"
                ? "vertical"
                : "horizontal";
            rpPanel.querySelector(".orient-text").textContent =
              shots[index].rpOrientation === "vertical" ? "垂直" : "水平";
            persist();
          });
          rpPanel.querySelector(".rp-divide").addEventListener("input", (e) => {
            shots[index].rpDivideRatio = e.target.value;
            persist();
          });
          rpPanel
            .querySelector(".rp-overlay")
            .addEventListener("input", (e) => {
              shots[index].rpOverlayRatio = e.target.value;
              persist();
            });

          const anchor = document.createElement("div");
          anchor.className = "scroll-spy-anchor";
          article.prepend(anchor);

          listEl.appendChild(article);
        });
      }

      // ---- 目录渲染 + 拖拽排序 + 高亮 ----
      let tocDragIndex = null;
      function renderTOC(activeId = null) {
        const currentActiveId = activeId || _activeArticleId;
        tocEl.innerHTML = "";
        if (!shots.length) return;
        shots.forEach((shot, i) => {
          const row = document.createElement("div");
          row.className =
            "toc-item w-full rounded-lg px-2 py-1 hover:bg-neutral-800/60 focus:outline-none focus:ring-1 focus:ring-neutral-600 flex items-center gap-2";
          row.setAttribute("draggable", "true");
          row.dataset.index = String(i);
          row.dataset.sid = shot.id;

          if (currentActiveId && shot.id === currentActiveId)
            row.classList.add("active");

          const handle = document.createElement("span");
          handle.className = "text-neutral-500 select-none";
          handle.textContent = "≡";

          const label = document.createElement("button");
          label.className = "text-left flex-1 truncate";
          const title = shot.title?.trim() || `分镜 ${i + 1}`;
          label.textContent = `${i + 1}. ${title}`;
          label.title = title;
          label.addEventListener("click", () => {
            const target = document.getElementById(`shot-${shot.id}`);
            if (target) {
              target.scrollIntoView({ behavior: "smooth", block: "start" });
              setActiveArticle(shot.id);
            }
          });

          row.appendChild(handle);
          row.appendChild(label);

          // 拖拽
          row.addEventListener("dragstart", (e) => {
            tocDragIndex = Number(e.currentTarget.dataset.index);
            e.dataTransfer.effectAllowed = "move";
            e.dataTransfer.setData("text/plain", String(tocDragIndex));
            row.classList.add("dragging");
          });
          row.addEventListener("dragover", (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
            row.classList.add("drop-target");
          });
          row.addEventListener("dragleave", () =>
            row.classList.remove("drop-target")
          );
          row.addEventListener("drop", (e) => {
            e.preventDefault();
            row.classList.remove("drop-target");
            const from =
              tocDragIndex ?? Number(e.dataTransfer.getData("text/plain"));
            const to = Number(row.dataset.index);
            if (!Number.isNaN(from) && !Number.isNaN(to)) reorder(from, to);
            tocDragIndex = null;
          });
          row.addEventListener("dragend", () => {
            document
              .querySelectorAll(".toc-item")
              .forEach((el) => el.classList.remove("dragging", "drop-target"));
            tocDragIndex = null;
          });

          tocEl.appendChild(row);
        });
      }

      // ---- 滚动高亮（Scroll Spy）----
      let _activeArticleId = shots[0]?.id || null;
      function setActiveArticle(id) {
        _activeArticleId = id;
        document.querySelectorAll(".toc-item").forEach((el) => {
          el.classList.toggle("active", el.dataset.sid === id);
        });
      }

      let spyTicking = false;
      function onScrollSpy() {
        if (spyTicking) return;
        spyTicking = true;
        requestAnimationFrame(() => {
          const topbar = document.querySelector(".topbar-sticky");
          const topOffset = (topbar?.offsetHeight || 0) + 12;
          const articles = Array.from(
            document.querySelectorAll("article.card")
          );
          let best = { id: null, d: Infinity };
          articles.forEach((a) => {
            const rect = a.getBoundingClientRect();
            const d = Math.abs(rect.top - topOffset);
            if (rect.bottom < topOffset) return;
            if (d < best.d) best = { id: a.id.replace("shot-", ""), d };
          });
          if (best.id && best.id !== _activeArticleId)
            setActiveArticle(best.id);
          spyTicking = false;
        });
      }
      window.addEventListener("scroll", onScrollSpy, { passive: true });

      function render() {
        renderList();
        renderTOC();
        computeStickyOffset();
        setTimeout(() => onScrollSpy(), 0);
      }

      // ---- CRUD ----
      function addShotAfter(idx) {
        const insertAt = Math.min(Math.max(idx + 1, 0), shots.length);
        const newShot = {
          id: uid(),
          title: "",
          summary: "",
          positive: "",
          negative: "",
          rpEnabled: false,
          rpOrientation: "vertical",
          rpDivideRatio: "",
          rpOverlayRatio: "",
        };
        shots.splice(insertAt, 0, newShot);
        persist();
        render();
        requestAnimationFrame(() => {
          const el = document.getElementById(`shot-${newShot.id}`);
          if (el) {
            el.scrollIntoView({ behavior: "smooth", block: "start" });
            const titleInput = el.querySelector('input[data-role="title"]');
            if (titleInput) {
              titleInput.focus();
              titleInput.select();
            }
          }
        });
      }
      function addShotToEnd() {
        addShotAfter(shots.length - 1);
      }

      function removeShot(idx) {
        if (shots.length <= 1) return;
        const removedId = shots[idx].id;
        shots = shots.filter((_, i) => i !== idx);
        persist();
        render();
        if (_activeArticleId === removedId)
          setActiveArticle(shots[Math.min(idx, shots.length - 1)]?.id || null);
      }

      function reorder(from, to) {
        if (
          from === to ||
          from < 0 ||
          to < 0 ||
          from >= shots.length ||
          to >= shots.length
        )
          return;
        const arr = shots.slice();
        const [moved] = arr.splice(from, 1);
        arr.splice(to, 0, moved);
        shots = arr;
        persist();
        render();
      }

      function resetAll() {
        // 也清空全局大标题输入框
        sceneTitle = "";
        if (typeof sceneTitleInput !== "undefined" && sceneTitleInput)
          sceneTitleInput.value = "";
        shots = [
          {
            id: uid(),
            title: "分镜 1",
            summary: "",
            positive: "",
            negative: "",
            rpEnabled: false,
            rpOrientation: "vertical",
            rpDivideRatio: "",
            rpOverlayRatio: "",
          },
        ];
        persist();
        render();
        toast("已重新开始，当前仅保留 1 条空白分镜。");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // ---- 状态 & 导入导出 ----
      function showStatus(text) {
        statusEl.textContent = text;
        statusEl.classList.remove("hidden");
        setTimeout(() => statusEl.classList.add("hidden"), 2500);
      }
      function toast(text) {
        showStatus(text);
      }

      /** 安全文件名 */
      function sanitizeFileName(name) {
        return (name || "").trim().replace(/[\\/:*?"<>|]/g, "_");
      }

      async function doExport() {
        const payload = {
          ...SIG,
          exportedAt: new Date().toISOString(),
          sceneTitle,
          items: shots.map(
            ({
              title,
              summary,
              positive,
              negative,
              rpEnabled,
              rpOrientation,
              rpDivideRatio,
              rpOverlayRatio,
            }) => ({
              title,
              summary,
              positive,
              negative,
              rpEnabled,
              rpOrientation,
              rpDivideRatio,
              rpOverlayRatio,
            })
          ),
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "text/plain;charset=utf-8",
        });

        const d = new Date();
        const stamp = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(
          2,
          "0"
        )}-${String(d.getDate()).padStart(2, "0")}`;
        const titlePart = sanitizeFileName(sceneTitle) || "sd-shot-list";
        const suggested = `${stamp} - ${titlePart}.txt`;

        if (window.showSaveFilePicker) {
          try {
            const handle = await window.showSaveFilePicker({
              suggestedName: suggested,
              types: [
                {
                  description: "Text File",
                  accept: { "text/plain": [".txt"] },
                },
              ],
            });
            const writable = await handle.createWritable();
            await writable.write(blob);
            await writable.close();
            toast("已保存导出文件。");
            return;
          } catch (err) {
            if (err?.name === "AbortError") {
              toast("已取消保存。");
              return;
            }
          }
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = suggested;
        document.body.appendChild(a);
        a.click();
        a.remove();
        toast("文件已生成（某些浏览器可能直接下载）。");
      }

      function doImport(file) {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const text = String(reader.result || "");
            const parsed = JSON.parse(text);
            if (
              !parsed ||
              parsed.type !== "sd-shot-list" ||
              !Array.isArray(parsed.items)
            )
              throw new Error("无效的 sd-shot-list 格式");

            sceneTitle = String(parsed.sceneTitle ?? "");
            sceneTitleInput.value = sceneTitle;

            let next = [];
            if (parsed.version === 3) {
              next = parsed.items.map((it) => ({
                id: uid(),
                title: String(it.title ?? ""),
                summary: String(it.summary ?? ""),
                positive: String(it.positive ?? ""),
                negative: String(it.negative ?? ""),
                rpEnabled: Boolean(it.rpEnabled ?? false),
                rpOrientation:
                  it.rpOrientation === "horizontal" ||
                  it.rpOrientation === "vertical"
                    ? it.rpOrientation
                    : "vertical",
                rpDivideRatio: String(it.rpDivideRatio ?? ""),
                rpOverlayRatio: String(it.rpOverlayRatio ?? ""),
              }));
            } else if (parsed.version === 2) {
              next = parsed.items.map((it) => ({
                id: uid(),
                title: String(it.title || ""),
                summary: "",
                positive: String(it.positive || ""),
                negative: String(it.negative || ""),
                rpEnabled: false,
                rpOrientation: "vertical",
                rpDivideRatio: "",
                rpOverlayRatio: "",
              }));
            } else if (parsed.version === 1) {
              next = parsed.items.map((it) => ({
                id: uid(),
                title: String(it.title || ""),
                summary: "",
                positive: String(it.prompt || ""),
                negative: "",
                rpEnabled: false,
                rpOrientation: "vertical",
                rpDivideRatio: "",
                rpOverlayRatio: "",
              }));
            } else {
              throw new Error("不支持的版本号");
            }
            if (!next.length) throw new Error("导入内容为空");
            shots = next;
            persist();
            render();
            toast(`已导入 ${next.length} 条分镜（v${parsed.version} → v3）`);
          } catch (err) {
            alert(err?.message || "导入失败：无法解析文件");
          } finally {
            fileInputEl.value = "";
          }
        };
        reader.readAsText(file);
      }

      // 事件绑定
      document
        .getElementById("btnImport")
        .addEventListener("click", () => fileInputEl.click());
      fileInputEl.addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        if (f) doImport(f);
      });
      btnExport.addEventListener("click", doExport);
      btnAdd.addEventListener("click", () => addShotToEnd());
      btnReset.addEventListener("click", () => {
        if (confirm("确定要重新开始吗？这会清空页面内容并只保留一个空白分镜。"))
          resetAll();
      });
      btnTop.addEventListener("click", () =>
        window.scrollTo({ top: 0, behavior: "smooth" })
      );

      // 启动
      render();
    </script>
  </body>
</html>
